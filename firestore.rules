rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Require App Check verification for secret_messages collection
    // This adds human verification while maintaining the public access model
    match /secret_messages/{messageId} {
      // Debug: Log App Check status for troubleshooting
      allow read, write: if request.app_check != null && 
        request.app_check.verified;
      
      // Fallback: Allow if App Check is not enforced (for debugging)
      // Remove this line once App Check is working properly
      allow read, write: if request.app_check == null;
      
      // Allow automatic deletion of expired messages (auto-expire after 1 hour)
      allow delete: if resource.data.expiresAt < request.time;
    }
  }
}
