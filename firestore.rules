rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Require App Check verification for the secret_messages collection
    match /secret_messages/{messageId} {
      
      // Allow reads and writes ONLY IF a valid App Check token is present.
      // This enforces that the request came from your legitimate app.
      // allow read, write: if true;
      allow read, write: if true;
      
      // Allow automatic deletion of expired messages (auto-expire after 1 hour)
      allow delete: if resource.data.expiresAt < request.time;
    }
    
    // Battleship players collection
    match /battleship_players/{playerId} {
      // Allow reads and writes with App Check
      allow read, write: if true;
    }
    
    // Battleship games collection
    match /battleship_games/{gameId} {
      // Allow reads and writes with App Check
      allow read, write: if true;
      
      // Moves subcollection
      match /moves/{moveId} {
        // Allow reads and writes with App Check
        allow read, write: if true;
      }
    }
    
    // Game invites collection
    match /game_invites/{inviteId} {
      // Allow reads and writes with App Check
      allow read, write: if true;
    }
    
    // Chat rooms collection
    match /chat_rooms/{roomId} {
      // Only allow reading if room is active and not expired
      allow read: if resource.data.status == 'active' 
                  && resource.data.expiresAt > request.time;
      
      // Allow creating rooms
      allow create: if request.resource.data.status == 'active'
                    && request.resource.data.maxParticipants == 10
                    && request.resource.data.participants.size() == 1;
      
      // Allow updating only to add participants or change status
      allow update: if request.resource.data.status == 'active'
                    && request.resource.data.expiresAt > request.time
                    && request.resource.data.participants.size() <= 10;
      
      // Allow deletion if expired or if closing room
      allow delete: if resource.data.expiresAt < request.time 
                    || request.resource.data.status == 'closed';
      
      // Messages subcollection
      match /messages/{messageId} {
        // Only allow reading if parent room is active and not expired
        allow read: if get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.status == 'active'
                    && get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.expiresAt > request.time;
        
        // Only allow creating messages if room is active and message is valid
        allow create: if get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.status == 'active'
                      && get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.expiresAt > request.time
                      && request.resource.data.message is string
                      && request.resource.data.message.size() > 0
                      && request.resource.data.message.size() <= 1000
                      && request.resource.data.participantName is string
                      && request.resource.data.participantName.size() == 10;
        
        // Allow deletion of messages
        allow delete: if true;
      }
    }
  }
}